<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.web.pdt.plan.dao.PlanMapper">
<select id="list" resultType="com.onetouch.web.pdt.plan.dao.PlanVO">
	select PLAN_NO,DUE_DATE,ORD_SHT_NO,WORK_PROT,PLAN_DATE from pdt_plan
	
</select>
<select id="selectDtl" resultType="com.onetouch.web.pdt.plan.dao.PlanVO">
	select prd_cd, cnt as need_cnt from pdt_ord_view where ORD_SHT_NO=#{ordShtNo}
</select>
<select id="findPrcCd" resultType="com.onetouch.web.fct.info.dao.InfoVO">
	select a.fct_cd , a.fct_nm , a.prc_cd
	from fct_info a join (select prc_cd from adm_prc_flow where prd_cd=#{prdCd}) b
	on(a.prc_cd = b.prc_cd)
</select>
<insert id="insertPlan">
	<!-- <foreach collection="list" item="alist">
	insert into pdt_plan (PLAN_NO,DUE_DATE,ORD_SHT_NO,WORK_PROT,PLAN_DATE) 
	values(
   PKG_MAKE_CODE.CODE('PPL','pdt_plan','PLAN_NO', 'plan_date')
   ,to_date(#{alist.dueDate},'yyyy-mm-dd HH24:MI:SS')
   ,#{alist.ordShtNo},#{alist.workProt},sysdate
	)     동적쿼리하다감
	</foreach> -->
	insert into pdt_plan (PLAN_NO,DUE_DATE,ORD_SHT_NO,WORK_PROT,PLAN_DATE) 
	values(
   PKG_MAKE_CODE.CODE('PPL','pdt_plan','PLAN_NO', 'plan_date')
   ,to_date(#{dueDate},'yyyy-mm-dd HH24:MI:SS')
   ,#{ordShtNo},#{workProt},sysdate
	)
</insert>
	<delete id="deletePlan">
		delete from pdt_plan where plan_no=#{planNo}	
	</delete>
<!-- 제품명검색해서 로트별 재고보기 -->
<select id="lotCntSelect" parameterType="com.onetouch.web.pdt.plan.dao.PlanVO" resultType="com.onetouch.web.pdt.plan.dao.PlanVO">
    select a.use_amt as useAmt,a.mtrlot as mtrLot , a.stckCnt as stckCnt , a.hldCnt as hldCnt , a.mtrcd as mtrCd , b.prd_cd as prdCd , b.need_cnt*a.use_amt as needCnt 
    from (select a.prc_cd as prcCd,a.use_amt as use_amt,b.mtr_lot as mtrLot ,b.stck_cnt as stckCnt,b.hld_cnt as hldCnt ,b.mtr_cd as mtrCd ,a.prd_cd as prd_cd
            from adm_bom a join mtr_lot_stck b
            on (a.mtr_cd = b.mtr_cd)
            where a.prd_cd=#{prdCd} AND a.prc_cd = #{prcCd}) a join (select prd_cd, cnt as need_cnt from pdt_ord_view where ORD_SHT_NO=#{ordShtNo}) b
            on(a.prd_cd= b.prd_cd) 
</select>	
<insert id="planDtlInsert">
	insert into pdt_plan_dtl (plan_dtl_no, plan_no,prd_cd, prc_cd, need_cnt, instr_cnt) 
	values(
	substr((select PKG_MAKE_CODE.CODE('PPD','pdt_plan_dtl','PLAN_DTL_NO') as planDtlNo from dual),0,11)||lpad((select PKG_MAKE_CODE_SEQ.CODE('PDT_PLAN_DTL','PLAN_DTL_NO') from dual) ,4,'0'),
	#{planNo},
	#{prdCd},
	#{prcCd},
	#{needCnt},
	#{instrCnt})
</insert>
<insert id="LotFindInsert">
	insert into used_mtr_lot (mtr_lot, instr_dtl_no, dtl_select) 
	values (
	#{mtrLot},
	substr(#{planDtlNo},0,11)||lpad(substr(#{planDtlNo},12,4),4,'0'),
	'PD')
</insert>
<select id="findPlanSeq" resultType="com.onetouch.web.pdt.plan.dao.PlanVO">
	select PKG_MAKE_CODE.CODE('PPD','pdt_plan_dtl','PLAN_DTL_NO') as planDtlNo from dual
</select>
<select id="findPlanSeqOnlyNum" resultType="int">
	select PKG_MAKE_CODE_SEQ.CODE('PDT_PLAN_DTL','PLAN_DTL_NO') from dual
</select>

</mapper>